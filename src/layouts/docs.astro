---
import { getCollection, getEntry, render } from "astro:content";
import Navbar from "components/partials/navbar.astro";
import WebComponent from "components/partials/web-component.astro";
import Master from "layouts/master.astro";

type Heading = {
  depth: number;
  slug: string;
  text: string;
  children?: Heading[];
};

function transformHeadings(headings: Heading[]): Heading[] {
  const result: Heading[] = [];
  const stack: Heading[] = [];

  for (const heading of headings) {
    const current = { ...heading };

    // Remove all items from stack that have greater or equal depth
    while (stack.length > 0 && stack[stack.length - 1].depth >= current.depth) {
      stack.pop();
    }

    if (stack.length === 0) {
      // This is a top-level heading
      result.push(current);
      stack.push(current);
    } else {
      // This is a child heading
      const parent = stack[stack.length - 1];
      if (!parent.children) {
        parent.children = [];
      }
      parent.children.push(current);
      stack.push(current);
    }
  }

  return result;
}

function transformTitles(string: string) {
  const wordReplacements: Record<string, string> = {
    and: "&",
    svg: "SVG",
  };
  const words = string.split("-");

  return words
    .map((word, index) => {
      const lowerWord = word.toLowerCase();

      // Check if word has a special replacement
      if (lowerWord in wordReplacements) {
        // Always capitalize first and last word, even if it's in the dictionary
        if (index === 0 || index === words.length - 1) {
          const replacement = wordReplacements[lowerWord];
          // If replacement is all caps (acronym), keep it; otherwise capitalize first letter
          return replacement === replacement.toUpperCase()
            ? replacement
            : replacement.charAt(0).toUpperCase() + replacement.slice(1);
        }
        return wordReplacements[lowerWord];
      }

      // Default title case
      return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    })
    .join(" ");
}

function titleCase(string: string) {
  return string
    .split("-")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
}

function isActive(href: string): boolean {
  if (`${project}/${entry.data.alias}` === href) {
    return true;
  }

  return entry.id === href;
}

type Group = {
  href: string;
  text: string;
  keywords: string | undefined;
  ping: boolean | undefined;
  submenu:
    | {
        href: string;
        text: string;
        target?: "_self" | "_blank" | "_parent" | "_top" | undefined;
      }[]
    | undefined;
  order: number | undefined;
};

const { version = "latest", id, project } = Astro.props;

const docs = (await getCollection("latest")).filter(
  (a) => a.data.project === project,
);

type Kit = {
  "getting-started": Group[];
  forms: Group[];
  components: Group[];
};

type Ft = {
  "getting-started": Group[];
  components: Group[];
};

type Style = {
  "getting-started": Group[];
  layout: Group[];
  "flex-and-grid": Group[];
  spacing: Group[];
  sizing: Group[];
  typography: Group[];
  backgrounds: Group[];
  borders: Group[];
  effects: Group[];
  filters: Group[];
  tables: Group[];
  "transitions-and-animations": Group[];
  transforms: Group[];
  interactivity: Group[];
  svg: Group[];
  accessibility: Group[];
};

const groups: {
  kit: Kit;
  ft: Ft;
  style: Style;
} = {
  kit: {
    "getting-started": [],
    forms: [],
    components: [],
  },
  ft: {
    "getting-started": [],
    components: [],
  },
  style: {
    "getting-started": [],
    layout: [],
    "flex-and-grid": [],
    spacing: [],
    sizing: [],
    typography: [],
    backgrounds: [],
    borders: [],
    effects: [],
    filters: [],
    tables: [],
    "transitions-and-animations": [],
    transforms: [],
    interactivity: [],
    svg: [],
    accessibility: [],
  },
};

docs.forEach((a: any) => {
  if (a.data.hidden !== true) {
    groups[project as "kit" | "style"][a.data.group as "getting-started"].push({
      href: a.id,
      text: a.data.text,
      keywords: a.data.keywords,
      ping: a.data.ping,
      submenu: a.data.submenu,
      order: a.data.order,
    });
  }
});

const entry = await getEntry(version, id);
const { Content, headings, remarkPluginFrontmatter } = await render(entry);
const tbc = transformHeadings(headings);
---

<Master
  doc={{
    title: `${remarkPluginFrontmatter.title}`,
    meta: { ...remarkPluginFrontmatter.meta, "docsearch:version": "latest" },
  }}
>
  <Navbar
    project={project}
    announcement={{
      headline: "Public preview",
    }}
  />

  <div class="root-layout">
    <aside class="root-sidebar">
      <div class="absolute inset" style="--inset: 0">
        <div
          class="root-sidebar-scrollable-area"
          x-data
          x-init='const asideL=document.querySelector(".root-sidebar-scrollable-area");if(asideL){let e=asideL.querySelector("li.uk-parent.uk-open"),i=e.querySelector("li.uk-active"),o={asideL:asideL.getBoundingClientRect(),focused:i.getBoundingClientRect()},t=i.offsetTop-asideL.offsetTop-o.asideL.height/2+o.focused.height/2;asideL.scrollTo({top:t,behavior:"smooth"})}'
        >
          <ul
            id="nav"
            class="uk-nav uk-nav-default mx mt"
            style="--mx: -1; --mt: 1"
            data-uk-nav="collapsible: false"
          >
            <li class="uk-nav-header">Documentation</li>
            {
              Object.keys(groups[project as "kit" | "style"]).map((a) => (
                <li
                  class={`uk-parent ${entry.data.group === a ? "uk-open" : ""}`}
                >
                  <a href="#">
                    {transformTitles(a)} <span data-uk-nav-parent-icon />
                  </a>
                  <ul class="uk-nav-sub" hidden={entry.data.group !== a}>
                    {groups[project as "kit" | "style"][a as "getting-started"]
                      .sort((z: Group, y: Group) => {
                        if (["getting-started"].includes(a)) {
                          return (z.order || 0) - (y.order || 0);
                        }

                        return z.text.localeCompare(y.text);
                      })
                      .map((z: Group, y) => (
                        <li
                          id={`test-${y}`}
                          class={isActive(z.href) ? "uk-active" : ""}
                        >
                          <a
                            class="display-flex items-center justify-between"
                            href={`/docs/latest/${z.href}`}
                          >
                            <span class="flex-1">{z.text}</span>
                            {z.ping === true ? (
                              <span
                                class="relative display-flex size flex-none"
                                style="--size: 2;"
                              >
                                <span
                                  class="bg/o absolute display-inline-flex h-full w-full animate-ping rounded-full"
                                  style="--bg: var(--color-primary); --bg-opacity: 75%"
                                />
                                <span
                                  class="bg relative display-inline-flex size rounded-full"
                                  style="--bg: var(--color-primary); --size: 2"
                                />
                              </span>
                            ) : (
                              ""
                            )}
                          </a>
                          {z.submenu ? (
                            <ul>
                              {z.submenu.map((y) => (
                                <li>
                                  <a
                                    class="display-flex items-center justify-between"
                                    href={y.href}
                                    target={y.target || "_self"}
                                  >
                                    <span class="flex-1">{y.text}</span>
                                    {y.href.startsWith("http") ? (
                                      <uk-icon icon="external-link" />
                                    ) : (
                                      ""
                                    )}
                                  </a>
                                </li>
                              ))}
                            </ul>
                          ) : (
                            ""
                          )}
                        </li>
                      ))}
                  </ul>
                </li>
              ))
            }
          </ul>

          <div
            class="mt p border-w border-dashed border/o"
            style="--mt: 4; --p: 2; --border-w: 1px; --border: var(--uk-border); --border-o: var(--uk-border-o)"
          >
            <img
              class="w-full aspect-square"
              src="/images/octocat-1766197044937.png"
            />

            <div class="text-lg font-bold">Support the Project</div>
            <p class="mt color" style="--mt: 2; --color: var(--uk-muted-f)">
              Your sponsorship helps keep it sustainable, supports new features,
              and ensures it remains free, and accessible for everyone.
            </p>

            <div
              class="mt display-flex flex-col gap"
              style="--mt: 2; --gap: 1.5"
            >
              <a
                class="uk-button uk-button-primary w-full"
                href="https://github.com/sponsors/sveltecult"
                target="_blank"
              >
                <uk-icon class="size" style="--size: 4;" icon="github"
                ></uk-icon>
                GitHub Sponsors
              </a>

              <a
                class="uk-button w-full"
                href="https://ko-fi.com/sveltecult"
                target="_blank"
              >
                <uk-icon class="size" style="--size: 4;" icon="coffee"
                ></uk-icon>
                Ko-Fi
              </a>
            </div>
          </div>
        </div>
      </div>
    </aside>
    <div class="root-divider-l divider-pattern"></div>
    <div class="root-main">
      <div
        class="isolate mx-auto grid w-full max-w-2xl grid-cols gap pt md:pb xl:max-w-5xl"
        style="--grid-cols: 1; --gap: 10; --pt: 10; --md-pb: 24"
      >
        <div class="px sm:px" style="--px: 4; --sm-px: 6">
          {
            entry.data.webc === true ? (
              <div class="mb" style="--mb: 5">
                <WebComponent />
              </div>
            ) : (
              ""
            )
          }

          <h1 class="uk-h1">
            {entry.data.title}
          </h1>

          {
            entry.data.lead ? (
              <p class="uk-text-lead mt" style="--mt: 2">
                {entry.data.lead}
              </p>
            ) : (
              ""
            )
          }

          {
            entry.data.wip === true ? (
              <div class="uk-alert-warning uk-alert mt" style="--mt: 6">
                This documentation is a work in progress.
              </div>
            ) : (
              ""
            )
          }

          {
            entry.data.tbc === false ? (
              ""
            ) : tbc.length > 0 ? (
              <Fragment>
                <h2
                  class="uk-h2 mt"
                  style="--mt: 10"
                  id="docs-table-of-contents"
                >
                  Table of contents
                </h2>

                <ul
                  class="uk-nav uk-nav-default ml mt"
                  style="--uk-nav-sub-width: 0; --uk-nav-item-display: inline-flex; --ml: -2; --mt: 6"
                >
                  {tbc.map((a) => (
                    <li>
                      <a href={`#${a.slug}`} data-uk-scroll="offset: 40">
                        <uk-icon
                          class="color mr size"
                          style="--color: var(--uk-danger); --mr: 2; --size: 4"
                          icon="hash"
                        />
                        {a.text}
                      </a>
                      {a.children ? (
                        <ul class="uk-nav-sub">
                          {a.children.map((b) => (
                            <li>
                              <a
                                href={`#${b.slug}`}
                                data-uk-scroll="offset: 40"
                              >
                                <uk-icon
                                  class="color mr size"
                                  style="--color: var(--uk-danger); --mr: 2; --size: 4"
                                  icon="hash"
                                />
                                {b.text}
                              </a>
                            </li>
                          ))}
                        </ul>
                      ) : (
                        ""
                      )}
                    </li>
                  ))}
                </ul>
              </Fragment>
            ) : (
              ""
            )
          }

          <Content />
        </div>
      </div>
    </div>
    <div class="root-divider-r divider-pattern"></div>
  </div>

  <uk-command id="cmd" key="/" toggle="search">
    <select data-fn="data-source" hidden>
      {
        Object.keys(groups[project as "kit" | "style"]).map((a) => (
          <optgroup label={titleCase(a)}>
            {groups[project as "kit" | "style"][a as "getting-started"].map(
              (z: Group) => (
                <option
                  data-icon="circle-dashed"
                  data-keywords={z.keywords}
                  value={`/docs/latest/${z.href}`}
                >
                  {z.text}
                </option>
              ),
            )}
          </optgroup>
        ))
      }
    </select>
  </uk-command>

  <div
    class="uk-offcanvas"
    data-uk-offcanvas="overlay: true"
    id="menu"
    style="--uk-offcanvas-bar-width: 320px; --uk-offcanvas-bar-width-i: -320px;"
  >
    <div class="uk-offcanvas-bar p" style="--p: 4">
      <div class="mb display-flex justify-center" style="--mb: 4">
        <button
          class="uk-button uk-button-secondary uk-button-xsmall uk-offcanvas-close"
        >
          <uk-icon icon="arrow-left"></uk-icon>
          <span class="ml" style="--ml: 2">Close</span>
        </button>
      </div>

      <ul
        id="nav"
        class="uk-nav uk-nav-default mx mt"
        style="--mx: -1; --mt: 1"
        data-uk-nav="collapsible: false"
      >
        <li class="uk-nav-header">Documentation</li>
        {
          Object.keys(groups[project as "kit" | "style"]).map((a) => (
            <li class={`uk-parent ${entry.data.group === a ? "uk-open" : ""}`}>
              <a href="#">
                {titleCase(a)} <span data-uk-nav-parent-icon />
              </a>
              <ul class="uk-nav-sub" hidden={entry.data.group !== a}>
                {groups[project as "kit" | "style"][a as "getting-started"]
                  .sort((z: Group, y: Group) => {
                    if (["getting-started"].includes(a)) {
                      return (z.order || 0) - (y.order || 0);
                    }

                    return z.text.localeCompare(y.text);
                  })
                  .map((z: Group, y) => (
                    <li
                      id={`test-${y}`}
                      class={isActive(z.href) ? "uk-active" : ""}
                    >
                      <a
                        class="display-flex items-center justify-between"
                        href={`/docs/latest/${z.href}`}
                      >
                        <span class="flex-1">{z.text}</span>
                        {z.ping === true ? (
                          <span
                            class="relative display-flex size flex-none"
                            style="--size: 2"
                          >
                            <span
                              class="bg/o absolute display-inline-flex h-full w-full animate-ping rounded-full"
                              style="--bg: var(--color-primary); --bg-opacity: 75%"
                            />
                            <span
                              class="bg relative display-inline-flex size rounded-full"
                              style="--bg: var(--color-primary); --size: 2"
                            />
                          </span>
                        ) : (
                          ""
                        )}
                      </a>
                      {z.submenu ? (
                        <ul>
                          {z.submenu.map((y) => (
                            <li>
                              <a
                                class="display-flex items-center justify-between"
                                href={y.href}
                                target={y.target || "_self"}
                              >
                                <span class="flex-1">{y.text}</span>
                                {y.href.startsWith("http") ? (
                                  <uk-icon icon="external-link" />
                                ) : (
                                  ""
                                )}
                              </a>
                            </li>
                          ))}
                        </ul>
                      ) : (
                        ""
                      )}
                    </li>
                  ))}
              </ul>
            </li>
          ))
        }
      </ul>
    </div>
  </div>

  <script is:inline>
    const observer = new MutationObserver(() => {
      if (htmlElement.classList.contains("dark")) {
        document.documentElement.dataset.theme = "github-dark";
      } else {
        document.documentElement.dataset.theme = "github-light";
      }
    });

    observer.observe(htmlElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    const cmd = document.getElementById("cmd");

    cmd &&
      cmd.addEventListener("uk-command:click", (e) => {
        location.href = e.detail.value.value;
      });
  </script>
</Master>
